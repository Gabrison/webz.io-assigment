pipeline {
    agent any
    environment {
        FLOATING_IP = "172.28.1.100"
        LOG_FILE = "/var/log/webz/active_node_ssh_log.txt"
    }
    stages {
        stage('Get Active Node via SSH and cURL') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'cluster-ssh', usernameVariable: 'SSH_USER', passwordVariable: 'SSH_PASS')]) {
                    script {
                        try {
                            def hostname = sh(
                                script: 'sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no $SSH_USER@$FLOATING_IP "hostname"',
                                returnStdout: true
                            ).trim()
                            def curl_output = sh(
                                script: 'curl -s http://$FLOATING_IP',
                                returnStdout: true
                            ).trim()
                            sh 'echo "$(date) - Host: ' + hostname + ' - Response: ' + curl_output + '" >> ' + LOG_FILE
                            sh 'cat ' + LOG_FILE
                        } catch (err) {
                            echo "ERROR: " + err.toString()
                            error('Pipeline failed: ' + err.toString())
                        }
                    }
                }
            }
        }
    }
}